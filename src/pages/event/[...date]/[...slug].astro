---
import { getCollection } from "astro:content";
import Event from "../../../layouts/EventPost.astro";
import { DateTime } from "luxon";
import {
    eventForDate,
    matchesConfiguration,
    eventCanceled,
    eventMissed,
    type RawCalendarEvent,
} from "../../../components/calendar";
import type { Render } from "astro:content";

export async function getStaticPaths() {
    const events = await getCollection("events");

    const oldestEventDate = events
        .map((event) => DateTime.fromISO(event.data.start))
        .reduce((a, b) => (a < b ? a : b));
    const startDate = oldestEventDate.startOf("month").startOf("day");
    const endDate = DateTime.now()
        .plus({ years: 1 })
        .startOf("day")
        .endOf("year");

    const days = Math.ceil(endDate.diff(startDate, ["day"]).days);

    return Array.from({ length: days }).flatMap((_, i) => {
        const date = startDate.plus({ days: i });
        const formattedDate = date.toFormat("yyyy-MM-dd");
        return events
            .filter((event) => {
                return matchesConfiguration({
                    date,
                    event: event.data as RawCalendarEvent,
                });
            })
            .map((rawEvent) => {
                const { slug, data: rawData, render } = rawEvent;
                const { start, end, series, ...data } = rawData;

                const interval = eventForDate({
                    date,
                    originalInterval: { start, end },
                });

                const canceled = eventCanceled({
                    date,
                    canceledDates: series?.canceledDates,
                });
                const missed = eventMissed({
                    date,
                    missedDates: series?.missedDates,
                });

                return {
                    params: { slug: slug, date: formattedDate },
                    props: {
                        ...data,
                        interval,
                        canceled,
                        missed,
                        render,
                    },
                };
            });
    });
}

type Props = {
    title: string;
    description: string;
    headerImage: string;
    place:
        | {
              name: string | undefined;
              address: string | undefined;
              website: string | undefined;
              location:
                  | {
                        latitude: number;
                        longitude: number;
                    }
                  | undefined;
              phone: string | undefined;
              map: string | undefined;
          }
        | undefined;
    canceled: boolean;
    missed: boolean;
    interval: {
        start: DateTime;
        end: DateTime;
    };
    render: () => Render[".md"];
};

const { render, ...data } = Astro.props;
const { Content } = await render();
---

<Event {...data}>
    <Content />
</Event>
